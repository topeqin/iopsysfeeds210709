#!/bin/sh

# As part of sysupgrade we migrate the users custom changes to the
# new fs. (Those which differ from the first boot defaults.)


# Abort on any error.
set -e


# Do nothing if user want to discard old settings.
if [ -n "$SAVE_CONFIG" ] && [ $SAVE_CONFIG -eq 0 ]; then
	exit 0
fi


[ -d "/lib/config/snapshots/first_boot/uci" ] || exit 0


# Read the very first verion of the wireless settings.
chroot "${2}" uci -c "/lib/config/snapshots/first_boot/uci" \
	show wireless >"/tmp/wireless-first-$$"


# Let the current UCI export its wireless settings.
chroot "${2}" uci show wireless >"/tmp/wireless-current-$$"


# If there a diff between the two?
if grep -vFf "/tmp/wireless-first-$$"  "/tmp/wireless-current-$$" \
		>"/tmp/wireless-diff-$$" && [ -s "/tmp/wireless-diff-$$" ]; then

	[ -s "/etc/config/wireless" ] || : >>"/etc/config/wireless"

	# Migration of anonymous section requires special handling.
	grep ']=' "/tmp/wireless-current-$$" | tr ".@=" " " | \
		awk '{
			if(system("uci -q get "$1".@"$2" >/dev/null") != 0 &&				# Does it already exit?
					system("uci add "$1" "$3" >/dev/null") != 0) {				# If not, then create it.
				exit 1;
			}
		}'

	# Import the diff into the next UCI database. The eval
	# is for string parsing of quotation marks.
	while read -t 5 -s line; do
		uci set "$(eval echo $line)"
	done <"/tmp/wireless-diff-$$"
fi

# Report success.
logger -s -p daemon.info -t post-hooks -- "UCI wireless migrated."

exit 0

