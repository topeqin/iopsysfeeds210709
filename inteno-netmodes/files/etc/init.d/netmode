#!/bin/sh /etc/rc.common

START=10
USE_PROCD=1

. /usr/share/libubox/jshn.sh
. /lib/network/config.sh

local modedir=$(uci -q get netmode.setup.dir)
[ -n "$modedir" ] || modedir="/etc/netmodes"

get_device() {
	local PORT_NAMES=$(db get hw.board.ethernetPortNames)
	local PORT_ORDER=$(db get hw.board.ethernetPortOrder)
        local cnt=1
        local idx=0

	local pnum=$(echo $PORT_NAMES | wc -w)

	if [ $pnum -le 2 ]; then
		PORT_NAMES=$(echo $PORT_NAMES | sed 's/LAN/LAN1/g')
	fi

	# get index of interface name
	for i in $PORT_NAMES; do
		if [ "$i" == "$1" ]; then
			idx=$cnt
		fi
		cnt=$((cnt+1))
	done

        # get port name from index
	cnt=1
	for i in $PORT_ORDER; do
		if [ "$cnt" == "$idx" ]; then
			echo $i
		fi
		cnt=$((cnt+1))
	done
}

populate_netmodes() {
	[ -f /etc/config/netmode -a -d $modedir ] || return

	delete_netmode() {
		uci delete netmode.$1
	}

	config_load netmode

	config_foreach delete_netmode netmode
	uci commit netmode

	wan=$(get_device WAN)
	lan1=$(get_device LAN1)
	lan2=$(get_device LAN2)
	lan3=$(get_device LAN3)
	lan4=$(get_device LAN4)
	lan5=$(get_device LAN5)

	for file in $(find $modedir -type f); do
		grep -q "\$WAN" $file && sed -i "s/\$WAN/$wan/g" $file
		grep -q "\$LAN1" $file && sed -i "s/\$LAN1/$lan1/g" $file
		grep -q "\$LAN2" $file && sed -i "s/\$LAN2/$lan2/g" $file
		grep -q "\$LAN3" $file && sed -i "s/\$LAN3/$lan3/g" $file
		grep -q "\$LAN4" $file && sed -i "s/\$LAN4/$lan4/g" $file
	done

	local hardware=$(db get hw.board.hardware)
	local keys lang desc exp exclude
	for mode in $(ls $modedir); do
			lang=""
			desc=""
			exp=""
			uci -q set netmode.$mode=netmode
			uci -q set netmode.$mode.conf=$mode
			json_load "$(cat $modedir/$mode/DETAILS)"

			exclude=0
			json_get_var excluded_boards excluded_boards
			for board in $excluded_boards; do
				if [ "$board" == "$hardware" ]; then
					uci -q delete netmode.$mode
					exclude=1
					break
				fi
			done
			[ $exclude -eq 1 ] && continue

			json_select description
			json_get_keys keys
			for k in $keys; do
				json_get_keys lang $k
				lang=$(echo $lang | sed 's/^[ \t]*//;s/[ \t]*$//')
				json_select $k
				json_get_var desc $lang
				uci -q set netmode.$mode."desc_$lang"="$desc"
				[ "$lang" == "en" ] && uci -q set netmode.$mode."desc"="$desc"
				json_select ..
			done
			json_select ..

			json_select explanation
			json_get_keys keys
			for k in $keys; do
				json_get_keys lang $k
				lang=$(echo $lang | sed 's/^[ \t]*//;s/[ \t]*$//')
				json_select $k
				json_get_var exp $lang
				uci -q set netmode.$mode."exp_$lang"="$exp"
				[ "$lang" == "en" ] && uci -q set netmode.$mode."exp"="$exp"
				json_select ..
			done
			json_select ..

			json_get_var cred credentials
			uci -q set netmode.$mode.askcred="$cred"
			json_get_var reboot reboot
			uci -q set netmode.$mode.reboot="$reboot"
	done
	uci commit netmode
}

switch_netmode() {
	[ -f /etc/config/netmode -a -d $modedir ] || return

	config_load netmode

	config_get curmode setup curmode
	config_get conf $curmode conf
	cp /etc/netmodes/$conf/* /etc/config/
	rm -f /etc/config/DETAILS
	sync
	local reboot=$(uci -q get netmode.$curmode.reboot)
	if [ "$reboot" == "0" ]; then
		/etc/init.d/enviroment reload
	else
		reboot &
	fi
}

start_service() {
	populate_netmodes
}

reload_service() {
        switch_netmode
}

service_triggers()
{
	procd_add_reload_trigger netmode
}

