#!/bin/sh

. /usr/share/libubox/jshn.sh

bcom_get_queue_stats() {
	i=0

	json_init
	json_add_array "queues"

	while :
	do
		qid="q$i"
		ifname=$(uci -q get qos.$qid.ifname)

		# if ifname is empty that is good enough to break
		if [ -z "$ifname" ];then
			break
		fi

		order=$(uci -q get qos.$qid.precedence)
		stats="$(tmctl getqstats --devtype 0 --if $ifname --qid $order)"
		json_add_object ""
		json_add_string "qid" "$qid"
		json_add_string "iface" "$ifname"

		IFS=$'\n'
		for stat in $stats; do
			pname="$(echo $stat | awk '{print$1}')"
			if [ $pname == 'ret' ]; then
				continue
			fi

			val="$(echo $stat | awk '{print$2}')"

			# remove trailing : from the name
			pname="${pname::-1}"

			# convert to iopsyswrt names
			case "$pname" in
				txPackets)
					json_add_string "tx_packets" "$val"
				;;
				txBytes)
					json_add_string "tx_bytes" "$val"
				;;
				droppedPackets)
					json_add_string "tx_dropped_packets" "$val"
				;;
				droppedBytes)
					json_add_string "tx_dropped_bytes" "$val"
				;;
			esac
		done

		json_close_object
		i=$((i + 1))
	done

	json_close_array
	json_dump
}

get_queue_stats() {
	if [ "$(which tmctl)" ]; then
		bcom_get_queue_stats
	fi
}


case "$1" in
	list)
		echo '{ "queue_stats" : {} }'
	;;
	call)
		case "$2" in
			queue_stats)
				get_queue_stats
			;;
		esac
	;;
esac
